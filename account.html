<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Account – Starplanner</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --pastel-orange:#FFC88B;
  --pastel-yellow:#FFF7B2;
  --pastel-pink:#FFD6DA;
  --gold-stroke:#FFE9A6;
  --btn:#FFC04D;
  --btn-hover:#EAA23D;
  --salmon:#FF9A6A;
  --salmon-hover:#FF864F;
  --cream:#FFFDF6;
}
*{box-sizing:border-box}
body{font-family:'Montserrat Alternates',sans-serif;margin:0;background:#fff;}
nav{background-image:url('ArtworkWaterverfkwastachterkopjes.jpg');background-repeat:no-repeat;background-position:center;background-size:120% 110%;padding:40px 60px;display:flex;justify-content:space-between;align-items:center;}
nav ul{list-style:none;margin:0;padding:0;display:flex;gap:70px;padding-left:100px;}
nav ul li a{text-decoration:none;color:white;font-size:18px;font-weight:600;text-shadow:1px 1px 3px rgba(0,0,0,0.3);}
nav ul li a:hover{color:#FF7929;}
.nav-icons{display:flex;gap:30px;align-items:center;}
.nav-icons img{width:36px;height:36px;cursor:pointer;}
.cart-link{position:relative;}
.cart-badge{position:absolute;top:-6px;right:-6px;background:#FF6F61;color:#fff;font-size:12px;font-weight:600;padding:2px 6px;border-radius:50%;min-width:18px;text-align:center;}

main{max-width:1100px;margin:60px auto;padding:0 20px;}
.account-shell{display:grid;grid-template-columns:260px 1fr;gap:24px;}
.sidebar{background:var(--cream);border-radius:18px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,.06);text-align:center;}
.avatar{
  width:120px;height:120px;border-radius:50%;margin:0 auto 18px;position:relative;
  background:linear-gradient(145deg,#FFFBEA,#FFE39C);
  border:4px solid #FFA94D;display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 10px rgba(255,170,70,0.25);overflow:hidden;transition:transform .18s ease;
}
.avatar:hover{ transform:scale(1.04); }
.avatar svg{width:65px;height:65px;fill:#FFB766;transition:opacity .2s;}
.avatar.has-photo svg{opacity:0;}
.avatar img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;}
.avatar.has-photo img{display:block;}
/* Wit 3D plusje */
.plus-btn{
  position:absolute;inset:0;margin:auto;width:40px;height:40px;border:none;background:transparent;cursor:pointer;
  display:flex;align-items:center;justify-content:center;z-index:2;transform:scale(1);transition:transform .14s ease;
}
.plus-btn:hover{ transform:scale(1.1); }
.plus-btn:before, .plus-btn:after{
  content:""; position:absolute; background:#ffffff; border-radius:2px;
  box-shadow:0 1px 0 rgba(0,0,0,.12), 0 4px 10px rgba(0,0,0,.15);
}
.plus-btn:before{ width:70%; height:3px; }
.plus-btn:after{ height:70%; width:3px; }

/* Sidebar heading */
.side-title{
  font-family:'Playfair Display',serif;font-size:28px;font-weight:700;margin:0 0 20px;
  background:linear-gradient(90deg,#FFD974,#FFB84C);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;
}

/* Side nav (origineel) */
.side-nav{display:flex;flex-direction:column;gap:8px;}
.side-nav button{background:none;border:none;padding:10px 14px;font-family:'Playfair Display',serif;font-size:18px;cursor:pointer;color:#FFB84C;text-shadow:0 0 1px #FFE6A5;transition:color .2s;}
.side-nav button:hover,.side-nav button.active{color:#FFA040;text-shadow:0 0 3px #FFE9A6;}
.logout-btn{
  width:100%;background:var(--salmon);color:#fff;border:none;border-radius:12px;padding:14px 0;font-size:18px;
  font-family:'Montserrat Alternates',sans-serif;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;
  text-shadow:1px 1px 3px rgba(0,0,0,0.25);margin-top:20px;cursor:pointer;box-shadow:0 4px 8px rgba(255,160,110,0.3);
  transition:background .25s ease, transform .15s ease;
}
.logout-btn:hover{ background:var(--salmon-hover); transform:translateY(-1px); }

.content{background:var(--cream);border-radius:18px;padding:40px;box-shadow:0 6px 12px rgba(0,0,0,0.05);}

/* Sectietitels –zelfde zachte pastel voor álle h3 (uniform) */
.section-title{
  font-family:'Playfair Display',serif;font-size:26px;margin:0 0 14px;
  background:linear-gradient(90deg,var(--pastel-yellow),var(--pastel-orange),var(--pastel-pink));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  -webkit-text-stroke:1px var(--gold-stroke);
}

/* Orders */
.orders p{color:#FFAE42;font-family:'Playfair Display';font-size:17px;}
.order{background:#FFF8D8;border:2px solid #FFB84C;border-radius:12px;padding:14px;margin-bottom:12px;}
.order h4{margin:0 0 8px;color:#FFAE42;font-family:'Playfair Display';}

/* Buttons & inputs (origineel) */
.btn{display:inline-block;background:var(--btn);color:#fff;border:none;border-radius:10px;padding:12px 18px;cursor:pointer;font-weight:600;font-family:'Montserrat Alternates';}
.btn:hover{background:var(--btn-hover);}
input,select{width:100%;padding:10px;border:2px solid #FFD46A;border-radius:10px;font-size:15px;font-family:'Montserrat Alternates';margin-bottom:10px;}

/* WELCOME! – ORIGINELE OMBRE + extra 3D-rand (alleen schaduw toegevoegd) */
.welcome-area{text-align:center;margin-bottom:40px;}
.welcome-area h1{
  font-family:'Playfair Display',serif;
  font-size:64px;
  letter-spacing:0.5px;
  background:linear-gradient(90deg,#FFF7B2,#FFB85C); /* exact origineel */
  -webkit-background-clip:text;                     /* exact origineel */
  -webkit-text-fill-color:transparent;              /* exact origineel */
  margin:0;
  font-weight:700;
  /* subtiele gelaagde 3D-rand */
  text-shadow:
    0 1px   0 #e6c985,
    0 2px   0 #dbb86f,
    0 3px   0 #d0a85a,
    0 6px  12px rgba(0,0,0,.18);
}

footer{position:relative;margin:60px 0 0;overflow:hidden;}
.footer-decoration{width:100%;height:100px;object-fit:cover;display:block;}
.footer-text{position:absolute;bottom:10px;width:100%;text-align:center;color:#fff;font-size:14px;text-shadow:1px 1px 3px rgba(0,0,0,0.5);}

/* --- Compact Upload + Circle Crop Modal --- */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px;}
.modal.open{display:flex;}
.modal-card{width:min(390px,95vw);background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.modal-title{font-family:'Playfair Display',serif;font-size:20px}
.modal-close{border:none;background:transparent;font-size:24px;cursor:pointer;line-height:1}

/* Kleine dropzone */
.dropzone{
  border:2px dashed #e2cf97;border-radius:14px;background:#f9f6ea;
  height:100px;display:flex;align-items:center;justify-content:center;text-align:center;padding:10px;position:relative;
  color:#8a7b5a;font-size:14px;margin-bottom:10px;
}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}

/* Cropvak met cirkelmask (duidelijk waar afgesneden wordt) */
.crop-wrap{position:relative;width:100%;max-height:260px;aspect-ratio:1/1;border-radius:14px;overflow:hidden;background:#f3efe3;border:2px dashed #e2cf97;}
.crop-canvas{position:absolute;inset:0;cursor:grab}
.crop-canvas.dragging{cursor:grabbing}
/* donker buiten de cirkel (78% van zijde) */
.mask-overlay{
  position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(circle at 50% 50%, transparent 39%, rgba(0,0,0,.5) 40%);
}
/* duidelijke witte rand van de cropcirkel */
.circle-outline{
  position:absolute;inset:0;pointer-events:none;border-radius:50%;
  width:78%;height:78%;left:11%;top:11%;
  border:2px solid #ffffff;
  box-shadow:0 0 0 2px rgba(0,0,0,.18) inset;
}
.modal-actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:10px}
.modal-actions input[type=range]{flex:1}
.hidden{display:none!important}
</style>
</head>
<body>
<header>
  <nav>
    <ul>
      <li><a href="index.html">HOME</a></li>
      <li><a href="thestorybehind.html">THE STORY BEHIND</a></li>
      <li><a href="shop.html">SHOP</a></li>
      <li><a href="plannertips.html">PLANNER TIPS</a></li>
      <li><a href="contact.html">CONTACT</a></li>
    </ul>
    <div class="nav-icons">
      <a href="account.html"><img src="user-icon.svg" alt="User"></a>
      <a href="checkout.html" class="cart-link">
        <img src="shoppingbag.svg" alt="Shopping Bag">
        <span class="cart-badge" id="cart-count">0</span>
      </a>
    </div>
  </nav>
</header>

<main>
  <section id="account-section">
    <div class="account-shell">
      <aside class="sidebar">
        <div class="avatar" id="avatar">
          <img id="avatar-img" alt="Profile photo">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.76 0 5-2.24 5-5S14.76 2 12 2 7 4.24 7 7s2.24 5 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"/></svg>
          <button class="plus-btn" id="avatar-plus" title="Add/Change photo" aria-label="Add or change profile photo"></button>
        </div>
        <p class="side-title">My Account</p>
        <div class="side-nav">
          <button class="active" data-target="sec-welcome">Home</button>
          <button data-target="sec-orders">Orders</button>
          <button data-target="sec-addresses">Personal data & address</button>
          <button data-target="sec-security">Security</button>
          <button data-target="sec-preferences">Preferences</button>
          <button data-target="sec-returns">Returns</button>
        </div>
        <button class="logout-btn" onclick="logout()">SIGN OUT</button>
      </aside>

      <div class="content">
        <section id="sec-welcome">
          <div class="welcome-area">
            <h1 id="welcome-name">Welcome!</h1>
          </div>
        </section>

        <section id="sec-orders" style="display:none;">
          <h3 class="section-title">My Orders</h3>
          <div id="orders" class="orders"><p>No orders</p></div>
        </section>

        <section id="sec-addresses" style="display:none;">
          <h3 class="section-title">Personal data & address</h3>
          <form id="form-ship" class="grid-1" style="max-width:500px;">
            <input id="ship_name" placeholder="Full name">
            <input id="ship_line1" placeholder="Address line 1">
            <input id="ship_city" placeholder="City">
            <input id="ship_postal" placeholder="Postal code">
            <input id="ship_country" placeholder="Country">
            <div class="actions-row" style="display:flex;gap:12px;">
              <button type="button" class="btn" id="btn-edit">Edit</button>
              <button type="button" class="btn" id="btn-save">Save</button>
            </div>
          </form>
        </section>

        <section id="sec-security" style="display:none;">
          <h3 class="section-title">Security</h3>
          <div style="max-width:500px;">
            <input type="password" id="cur_pass" placeholder="Current password">
            <input type="password" id="new_pass" placeholder="New password">
            <input type="password" id="new_pass_repeat" placeholder="Repeat new password">
            <button type="button" class="btn" onclick="changePassword()">Update password</button>
          </div>
        </section>

        <section id="sec-preferences" style="display:none;">
          <h3 class="section-title">Preferences</h3>
          <label>Language</label>
          <select id="pref-lang">
            <option value="en">English</option>
            <option value="nl">Nederlands</option>
          </select>
          <label>Currency</label>
          <select id="pref-cur">
            <option value="EUR">EUR (€)</option>
            <option value="USD">USD ($)</option>
          </select>
        </section>

        <section id="sec-returns" style="display:none;">
          <h3 class="section-title">Returns</h3>
          <form id="form-return" style="max-width:500px;">
            <input id="ret_order" placeholder="Order ID">
            <input id="ret_reason" placeholder="Reason">
            <button type="button" class="btn" onclick="submitReturn()">Submit return</button>
          </form>
        </section>
      </div>
    </div>
  </section>
</main>

<footer>
  <img src="ArtworkWaterverfkwastfootheader.jpg" alt="Footer Decoration" class="footer-decoration">
  <div class="footer-text">© 2025 Starplanner – All rights reserved.</div>
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-storage-compat.js"></script>

<!-- Compact Upload + Circle Crop Modal -->
<div class="modal" id="avatar-modal" aria-hidden="true" role="dialog" aria-label="Upload profile photo">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">Profile photo</div>
      <button class="modal-close" id="modal-close" aria-label="Close">×</button>
    </div>

    <!-- Kleine dropzone -->
    <div class="dropzone" id="dropzone">
      <div id="dz-text">Drag profile picture here or upload it here</div>
      <input type="file" id="file-input" accept="image/*">
    </div>

    <!-- Cirkel-cropper -->
    <div class="crop-wrap">
      <canvas id="crop-canvas" class="crop-canvas"></canvas>
      <div class="mask-overlay"></div>
      <div class="circle-outline"></div>
    </div>

    <div class="modal-actions">
      <input type="range" id="zoom" min="1" max="3" step="0.01" value="1" title="Zoom">
      <button class="btn" id="btn-save-photo">Save</button>
    </div>
  </div>
</div>

<script>
/* Firebase init */
const firebaseConfig={
  apiKey:"AIzaSyApt-W5-Ag4Ov2JxVcudSrV4VL0zCBE8pc",
  authDomain:"starplanner-3acf9.firebaseapp.com",
  projectId:"starplanner-3acf9",
  storageBucket:"starplanner-3acf9.appspot.com",
  messagingSenderId:"793684440573",
  appId:"1:793684440573:web:5beb2ab6f64b4fc110d594"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

/* Orders */
auth.onAuthStateChanged(async user=>{
 if(user){
   document.getElementById('welcome-name').textContent=`Welcome, ${user.email.split('@')[0]}!`;
   await loadOrders(user.uid);
   try{
     const snap=await db.collection('users').doc(user.uid).get();
     const url=snap.exists ? (snap.data().avatarUrl||"") : "";
     if(url) setAvatarImage(url);
   }catch(e){console.error(e);}
 }
});

async function loadOrders(userId){
  const ordersDiv=document.getElementById('orders');
  ordersDiv.innerHTML="<p>Loading your orders…</p>";
  try{
    const snap=await db.collection('orders').where('userId','==',userId).orderBy('date','desc').get();
    if(snap.empty){ ordersDiv.innerHTML="<p>No orders found.</p>"; return; }
    ordersDiv.innerHTML="";
    snap.forEach(doc=>{
      const o=doc.data();
      const date=o.date?.toDate?o.date.toDate().toLocaleString():"Unknown date";
      const total=typeof o.total==='number'?o.total.toFixed(2):"0.00";
      const items=(o.items||[]).map(i=>`<li>${escapeHtml(i.name)} – €${(i.price??0).toFixed(2)} × ${i.qty??1}</li>`).join("");
      const block=document.createElement("div");
      block.className="order";
      block.innerHTML=`<h4>Order on ${date}</h4><ul>${items}</ul><p><strong>Total:</strong> €${total}</p>`;
      ordersDiv.appendChild(block);
    });
  }catch(err){
    console.error(err);
    ordersDiv.innerHTML="<p>Error loading orders.</p>";
  }
}

/* Navigatie */
document.querySelectorAll('.side-nav button').forEach(btn=>{
 btn.addEventListener('click',()=>{
   document.querySelectorAll('.side-nav button').forEach(b=>b.classList.remove('active'));
   btn.classList.add('active');
   const tgt=btn.getAttribute('data-target');
   document.querySelectorAll('.content>section').forEach(s=>s.style.display=(s.id===tgt?'block':'none'));
 });
});

/* Logout */
function logout(){auth.signOut();}

/* Security */
async function changePassword(){
  const user=auth.currentUser; if(!user) return alert('Please sign in.');
  const current=document.getElementById('cur_pass').value.trim();
  const np=document.getElementById('new_pass').value.trim();
  const nr=document.getElementById('new_pass_repeat').value.trim();
  if(!current || !np || !nr) return alert('Fill in all fields.');
  if(np!==nr) return alert('New passwords do not match.');
  try{
    const cred=firebase.auth.EmailAuthProvider.credential(user.email,current);
    await user.reauthenticateWithCredential(cred);
    await user.updatePassword(np);
    alert('Password updated.');
    document.getElementById('cur_pass').value='';
    document.getElementById('new_pass').value='';
    document.getElementById('new_pass_repeat').value='';
  }catch(e){ console.error(e); alert(e.message||'Could not update password.'); }
}

/* Personal data & address — Edit + Save (zelfde layout als andere kopjes) */
document.getElementById('btn-edit').addEventListener('click', async ()=>{
  const user=auth.currentUser; if(!user) return alert('Please sign in.');
  try{
    const snap=await db.collection('users').doc(user.uid).get();
    if(snap.exists){
      const d=snap.data()||{};
      document.getElementById('ship_name').value=d.name||'';
      document.getElementById('ship_line1').value=d.address_line1||'';
      document.getElementById('ship_city').value=d.city||'';
      document.getElementById('ship_postal').value=d.postal||'';
      document.getElementById('ship_country').value=d.country||'';
    }else{
      alert('No saved details found yet. You can fill them in and press Save.');
    }
  }catch(e){ console.error(e); alert('Could not load your details.'); }
});
document.getElementById('btn-save').addEventListener('click', saveAddress);
async function saveAddress(){
  const user=auth.currentUser; if(!user) return alert('Please sign in.');
  const payload={
    name: document.getElementById('ship_name').value.trim(),
    address_line1: document.getElementById('ship_line1').value.trim(),
    city: document.getElementById('ship_city').value.trim(),
    postal: document.getElementById('ship_postal').value.trim(),
    country: document.getElementById('ship_country').value.trim(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{
    await db.collection('users').doc(user.uid).set(payload,{merge:true});
    alert('Details saved.');
  }catch(e){ console.error(e); alert('Could not save your details.'); }
}

/* ===== Avatar upload + CIRCULAR crop (compact & professioneel) ===== */
const avatar=document.getElementById('avatar');
const avatarImg=document.getElementById('avatar-img');
const plusBtn=document.getElementById('avatar-plus');
const modal=document.getElementById('avatar-modal');
const modalClose=document.getElementById('modal-close');

const dz=document.getElementById('dropzone');
const fileInput=document.getElementById('file-input');
const canvas=document.getElementById('crop-canvas');
const ctx=canvas.getContext('2d');
const zoomInput=document.getElementById('zoom');
const btnSavePhoto=document.getElementById('btn-save-photo');

let img=new Image();
let imgLoaded=false;
let minZoom=1;
let state={scale:1, x:0, y:0, dragging:false, startX:0, startY:0};

function setAvatarImage(url){
  avatar.classList.add('has-photo');
  avatarImg.src=url;
  avatarImg.alt='Profile photo';
}

plusBtn.addEventListener('click', openModal);
modalClose.addEventListener('click', closeModal);
modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.style.background='#f5efd9'; });
dz.addEventListener('dragleave', e=>{ dz.style.background='#f9f6ea'; });
dz.addEventListener('drop', e=>{
  e.preventDefault(); dz.style.background='#f9f6ea';
  const f=e.dataTransfer.files?.[0]; if(f) loadFile(f);
});
fileInput.addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(f) loadFile(f);
});

function openModal(){
  modal.classList.add('open');
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
}
function closeModal(){
  modal.classList.remove('open');
  window.removeEventListener('resize', resizeCanvas);
}

function resizeCanvas(){
  const wrap=document.querySelector('.crop-wrap');
  const size=Math.min(wrap.clientWidth, wrap.clientHeight);
  canvas.width=size; canvas.height=size;
  draw();
}

function loadFile(file){
  const reader=new FileReader();
  reader.onload=(ev)=>{
    imgLoaded=false;
    img=new Image();
    img.onload=()=>{
      imgLoaded=true;
      const W=canvas.width, H=canvas.height;
      // minimale zoom zodat het vierkant bedekt blijft (dus cirkel is ook altijd gevuld)
      minZoom=Math.max(W/img.width, H/img.height);
      state.scale=minZoom;
      zoomInput.min=minZoom.toFixed(2);
      zoomInput.value=minZoom.toFixed(2);
      state.x=(W - img.width*state.scale)/2;
      state.y=(H - img.height*state.scale)/2;
      draw();
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

/* tekenen + interactie (pan/zoom) */
function draw(){
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#f3efe3'; ctx.fillRect(0,0,W,H);
  if(imgLoaded){
    ctx.save(); ctx.imageSmoothingQuality='high';
    ctx.drawImage(img, state.x, state.y, img.width*state.scale, img.height*state.scale);
    ctx.restore();
  }
}
canvas.addEventListener('mousedown', e=>{
  if(!imgLoaded) return; state.dragging=true; canvas.classList.add('dragging');
  state.startX=e.offsetX - state.x; state.startY=e.offsetY - state.y;
});
window.addEventListener('mouseup', ()=>{ state.dragging=false; canvas.classList.remove('dragging'); });
canvas.addEventListener('mousemove', e=>{
  if(!state.dragging) return;
  state.x=e.offsetX - state.startX;
  state.y=e.offsetY - state.startY;
  draw();
});
zoomInput.addEventListener('input', e=>{
  if(!imgLoaded) return;
  const newScale=Math.max(parseFloat(e.target.value), minZoom);
  const W=canvas.width, H=canvas.height;
  const prev=state.scale;
  const cx=W/2, cy=H/2;
  state.x = cx - ((cx - state.x) * (newScale/prev));
  state.y = cy - ((cy - state.y) * (newScale/prev));
  state.scale=newScale; draw();
});

/* Save: exporteer exact de cirkel (78% van zijde) als rond PNG en upload */
document.getElementById('btn-save-photo').addEventListener('click', async ()=>{
  const user=auth.currentUser; if(!user) return alert('Please sign in.');
  if(!imgLoaded) return alert('Please upload an image first.');

  const size=512; // outputgrootte
  const out=document.createElement('canvas');
  out.width=size; out.height=size;
  const octx=out.getContext('2d');

  // clip naar cirkel (78% diameter -> radius 39%)
  const radius=size*0.39, cx=size/2, cy=size/2;
  octx.save();
  octx.beginPath(); octx.arc(cx, cy, radius, 0, Math.PI*2); octx.closePath(); octx.clip();

  // Map de huidige canvas-positie naar output
  const viewW=canvas.width;
  const scaleFactor = size / viewW;
  const dx = state.x * scaleFactor;
  const dy = state.y * scaleFactor;
  const dw = img.width * state.scale * scaleFactor;
  const dh = img.height * state.scale * scaleFactor;

  octx.imageSmoothingQuality='high';
  octx.drawImage(img, dx, dy, dw, dh);
  octx.restore();

  out.toBlob(async (blob)=>{
    if(!blob){ alert('Nothing to save.'); return; }
    try{
      const ref=storage.ref().child(`users/${user.uid}/avatar.png`);
      await ref.put(blob, {contentType:'image/png'});
      const url=await ref.getDownloadURL();
      await db.collection('users').doc(user.uid).set({avatarUrl:url, updatedAt: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      setAvatarImage(url);
      closeModal();
      alert('Profile photo saved.');
    }catch(e){ console.error(e); alert('Could not save your photo.'); }
  }, 'image/png');
});

/* Returns demo */
function submitReturn(){
  const id=document.getElementById('ret_order').value.trim();
  const reason=document.getElementById('ret_reason').value.trim();
  if(!id || !reason) return alert('Fill in order and reason.');
  alert('Return submitted. We will contact you soon.');
}

/* Utils */
function escapeHtml(str){ return String(str??'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
</script>

<!--
Apache serverconfiguratie voor caching en headers

<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
  Header set X-Content-Type-Options nosniff
  Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>
-->
</body>
</html>
