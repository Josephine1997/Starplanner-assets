<script>
/* --- Firebase & cart setup --- */
const firebaseConfig={apiKey:"AIzaSyApt-W5-Ag4Ov2JxVcudSrV4VL0zCBE8pc",authDomain:"starplanner-3acf9.firebaseapp.com",projectId:"starplanner-3acf9",storageBucket:"starplanner-3acf9.firebasestorage.app",messagingSenderId:"793684440573",appId:"1:793684440573:web:5beb2ab6f64b4fc110d594"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();const db=firebase.firestore();

const cartContainer=document.getElementById('cart-items');
const subtotalEl=document.getElementById('subtotal');
const cartCount=document.getElementById('cart-count');

let cart=(JSON.parse(localStorage.getItem('cart'))||[]).map(it=>({...it,qty:Number(it?.qty)>0?Number(it.qty):1,price:Number(it?.price)?Number(it.price):0}));
localStorage.setItem('cart',JSON.stringify(cart));
cartCount.textContent=cart.reduce((s,it)=>s+(Number(it.qty)||1),0);

function renderCart(){
  cartContainer.innerHTML='';let total=0;
  if(cart.length===0){cartContainer.innerHTML=`<div class="empty-cart">Your cart is empty</div>`;}
  else{
    cart.forEach((item,index)=>{
      const price=Number(item.price)||0;const qty=Number(item.qty)||1;
      const div=document.createElement('div');
      div.classList.add('cart-item');
      div.innerHTML=`<div style="display:flex;align-items:center;">
        <img src="shoppingbag.svg" alt="${item.name}">
        <div class="product-info">
          <div>${item.name}</div>
          <div class="remove" onclick="removeItem(${index})">REMOVE</div>
        </div></div>
        <div>€${price.toFixed(2)}<br>
          <div class="qty-controls">
            <button class="qty-btn" onclick="updateQty(${index},-1)">–</button>
            <span class="qty-box">${qty}</span>
            <button class="qty-btn" onclick="updateQty(${index},1)">+</button>
          </div>
        </div>`;
      cartContainer.appendChild(div);
      total+=price*qty;
    });
  }
  subtotalEl.textContent=total.toFixed(2);
}
renderCart();

/* --- Audio --- */
const whoosh=document.getElementById('sound-whoosh');
const chime=document.getElementById('sound-chime');
let soundReady=false;const queue=[];
function unlockAudio(){if(soundReady)return;soundReady=true;[whoosh,chime].forEach(a=>{try{a.play().then(()=>a.pause()).catch(()=>{});}catch(_){}});flushQueue();}
function playSound(el,vol=0.8){const fn=()=>{try{el.currentTime=0;el.volume=vol;el.play().catch(()=>{});}catch(_){}};if(soundReady)fn();else queue.push(fn);}
function stopSound(el){try{el.pause();el.currentTime=0;}catch(_){}} 
function flushQueue(){while(queue.length){try{queue.shift()();}catch(_){}}}
["click","touchstart","keydown","pointerdown"].forEach(ev=>{window.addEventListener(ev,unlockAudio,{once:true,passive:true});});

/* --- Stardust triggered by first scroll --- */
window.addEventListener('load',()=>{
  const overlay=document.getElementById('stardust-overlay');
  const textEl=overlay.querySelector('div:last-child');
  const container=document.getElementById('stardust');

  const justAdded=localStorage.getItem('justAdded')==='true';
  localStorage.removeItem('justAdded');
  if(!justAdded){fadeOut(2500);return;}

  function startStardust(){
    unlockAudio();
    textEl.textContent="Sprinkling a little stardust…";

    // 1️⃣ maak sterren
    const stars=[];
    for(let i=0;i<30;i++){
      const s=document.createElement('span');
      s.classList.add('star');
      const size=Math.random()*2+1;
      s.style.width=s.style.height=`${size}px`;
      s.style.top =`${Math.random()*window.innerHeight}px`;
      s.style.left=`${Math.random()*window.innerWidth}px`;
      s.style.animationDelay=`${Math.random()*2}s`;
      container.appendChild(s);
      stars.push(s);
    }

    // 2️⃣ bepaal doel: shoppingbag bij juiste productnaam
    const last=localStorage.getItem('lastAddedItemName');
    let targetBag=null;
    document.querySelectorAll('.cart-item').forEach(it=>{
      if(it.textContent.includes(last)){
        targetBag=it.querySelector('img');
      }
    });
    if(!targetBag){ // fallback
      targetBag=document.querySelector('.nav-icons img[alt="Shopping Bag"]');
    }

    const r=targetBag.getBoundingClientRect();
    const cx=r.left+r.width/2;
    const cy=r.top+r.height/2;

    // 3️⃣ start samenkomen na 1s (chime speelt direct hierbij)
    setTimeout(()=>{
      playSound(chime,0.8); // speelt bij begin van samenkomen
      stars.forEach((s,i)=>{
        const angle=i*0.35;
        s.style.transition='top 2s cubic-bezier(0.55,0.05,0.19,1),left 2s cubic-bezier(0.55,0.05,0.19,1),transform 2s ease-in-out,opacity 2s ease';
        setTimeout(()=>{
          s.style.top =`${cy+Math.sin(angle)*8}px`;
          s.style.left=`${cx+Math.cos(angle)*8}px`;
          s.style.transform=`scale(0.3) rotate(${angle*8}rad)`;
          s.style.opacity='0.9';
        },Math.random()*300);
      });
    },1000);

    // 4️⃣ wanneer sterren gearriveerd zijn → whoosh + explosie
    setTimeout(()=>{
      playSound(whoosh,0.9);

      const flare=document.createElement('div');
      flare.style.position='fixed';
      flare.style.left=`${cx-50}px`;flare.style.top=`${cy-50}px`;
      flare.style.width='100px';flare.style.height='100px';
      flare.style.borderRadius='50%';
      flare.style.background='radial-gradient(circle,rgba(255,255,200,0.9)0%,rgba(255,180,120,0.3)50%,transparent 80%)';
      flare.style.pointerEvents='none';flare.style.opacity='0';
      flare.style.transition='opacity .6s ease-out,transform .6s ease-out';
      flare.style.zIndex='10000';
      document.body.appendChild(flare);
      requestAnimationFrame(()=>{flare.style.opacity='1';flare.style.transform='scale(1.6)';});
      setTimeout(()=>flare.remove(),700);

      // mini sterrenexplosie
      for(let j=0;j<12;j++){
        const sp=document.createElement('span');
        sp.classList.add('star');
        sp.style.width='3px';sp.style.height='3px';
        sp.style.top =`${cy}px`;sp.style.left=`${cx}px`;sp.style.opacity='1';
        sp.style.transition='top .8s ease-out,left .8s ease-out,opacity .8s ease-out,transform .8s ease-out';
        container.appendChild(sp);
        const ang=Math.random()*Math.PI*2;
        const dist=60+Math.random()*90;
        requestAnimationFrame(()=>{
          sp.style.top =`${cy+Math.sin(ang)*dist}px`;
          sp.style.left=`${cx+Math.cos(ang)*dist}px`;
          sp.style.opacity='0';
          sp.style.transform='scale(0.6)';
        });
      }

      // stop beide geluiden na kort
      setTimeout(()=>{
        stopSound(chime);
        stopSound(whoosh);
      },1500);

      fadeOut(4000);
    },3100); // 1s wachten + 2s samenkomen = 3.1s totaal
  }

  function firstScroll(){
    window.removeEventListener('scroll',firstScroll);
    startStardust();
  }
  window.addEventListener('scroll',firstScroll,{once:true,passive:true});
});

function fadeOut(ms){
  const overlay=document.getElementById('stardust-overlay');
  setTimeout(()=>{
    overlay.style.transition='opacity 1s ease';
    overlay.style.opacity='0';
    setTimeout(()=>overlay.style.display='none',1000);
  },ms);
  setTimeout(()=>overlay.style.display='none',7000);
}
</script>
