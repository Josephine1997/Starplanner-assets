<script>
/* ðŸ”Š Audio setup */
const whoosh=document.getElementById('sound-whoosh');
const chime =document.getElementById('sound-chime');
let soundReady=false;
const queue=[];

function unlockAudio(){
  if(soundReady) return;
  soundReady=true;
  [whoosh,chime].forEach(a=>{
    try{a.play().then(()=>a.pause()).catch(()=>{});}catch(_){}
  });
  flushQueue();
}
function playSound(el,vol=0.8){
  const fn=()=>{try{el.currentTime=0;el.volume=vol;el.play().catch(()=>{});}catch(_){}}; 
  if(soundReady) fn(); else queue.push(fn);
}
function flushQueue(){while(queue.length){try{queue.shift()();}catch(_){}}}
["click","touchstart","keydown","pointerdown"].forEach(ev=>{
  window.addEventListener(ev,unlockAudio,{once:true,passive:true});
});

/* ðŸŒŒ Stardust animatie â€“ start pas bij eerste scroll */
window.addEventListener('load',()=>{
  const overlay=document.getElementById('stardust-overlay');
  const textEl = overlay.querySelector('div:last-child');
  const container=document.getElementById('stardust');
  const stars=[];
  for(let i=0;i<30;i++){
    const s=document.createElement('span');
    s.classList.add('star');
    const size=Math.random()*2+1;
    s.style.width=s.style.height=`${size}px`;
    s.style.top =`${Math.random()*window.innerHeight}px`;
    s.style.left=`${Math.random()*window.innerWidth}px`;
    s.style.animationDelay=`${Math.random()*2}s`;
    container.appendChild(s);
    stars.push(s);
  }

  const justAdded=localStorage.getItem('justAdded')==='true';
  localStorage.removeItem('justAdded');
  if(!justAdded){fadeOut(2500);return;}

  function startStardust(){
    textEl.textContent = "Sprinkling a little stardustâ€¦";
    const last=localStorage.getItem('lastAddedItemName');
    let target=document.querySelector('.cart-item img');
    if(last){
      document.querySelectorAll('.cart-item').forEach(it=>{
        if(it.textContent.includes(last)) target=it.querySelector('img');
      });
    }
    const r=target?target.getBoundingClientRect():{left:window.innerWidth/2,top:window.innerHeight/2,width:0,height:0};
    const cx=r.left+r.width/2;
    const cy=r.top+r.height/2;

    playSound(whoosh,0.8);

    stars.forEach((s,i)=>{
      const a=i*0.35; const d=Math.random()*220;
      s.style.transition='top 1.5s cubic-bezier(0.55,0.05,0.19,1),left 1.5s cubic-bezier(0.55,0.05,0.19,1),transform 1.5s ease-in-out,opacity 1.5s ease';
      setTimeout(()=>{
        s.style.top =`${cy+Math.sin(a)*5}px`;
        s.style.left=`${cx+Math.cos(a)*5}px`;
        s.style.transform=`scale(0.3) rotate(${a*8}rad)`;
        s.style.opacity='0.9';
      },d);
    });

    setTimeout(()=>{
      playSound(chime,0.9);
      const flare=document.createElement('div');
      flare.style.position='fixed';
      flare.style.left=`${cx-50}px`;flare.style.top=`${cy-50}px`;
      flare.style.width='100px';flare.style.height='100px';
      flare.style.borderRadius='50%';
      flare.style.background='radial-gradient(circle,rgba(255,255,200,0.9)0%,rgba(255,180,120,0.3)50%,transparent 80%)';
      flare.style.pointerEvents='none';flare.style.opacity='0';
      flare.style.transition='opacity .6s ease-out,transform .6s ease-out';
      flare.style.zIndex='10000';
      document.body.appendChild(flare);
      requestAnimationFrame(()=>{flare.style.opacity='1';flare.style.transform='scale(1.6)';});
      setTimeout(()=>flare.remove(),700);
      for(let j=0;j<12;j++){
        const sp=document.createElement('span');
        sp.classList.add('star');
        sp.style.width='3px';sp.style.height='3px';
        sp.style.top =`${cy}px`;sp.style.left=`${cx}px`;sp.style.opacity='1';
        sp.style.transition='top .8s ease-out,left .8s ease-out,opacity .8s ease-out,transform .8s ease-out';
        container.appendChild(sp);
        const ang=Math.random()*Math.PI*2;
        const dist=60+Math.random()*90;
        requestAnimationFrame(()=>{
          sp.style.top =`${cy+Math.sin(ang)*dist}px`;
          sp.style.left=`${cx+Math.cos(ang)*dist}px`;
          sp.style.opacity='0';
          sp.style.transform='scale(0.6)';
        });
      }
    },1500);

    fadeOut(4000);
  }

  // ðŸŒ€ Start animatie pas bij eerste scroll
  function firstScroll(){
    window.removeEventListener('scroll', firstScroll);
    unlockAudio();
    startStardust();
  }
  window.addEventListener('scroll', firstScroll, { once:true, passive:true });
});

function fadeOut(ms){
  const overlay=document.getElementById('stardust-overlay');
  setTimeout(()=>{
    overlay.style.transition='opacity 1s ease';
    overlay.style.opacity='0';
    setTimeout(()=>overlay.style.display='none',1000);
  },ms);
  setTimeout(()=>overlay.style.display='none',7000);
}
</script>
